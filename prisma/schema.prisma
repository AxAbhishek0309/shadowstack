// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  repositories Repository[]
  scans        Scan[]
  settings     UserSettings?

  @@map("users")
}

model UserSettings {
  id                String  @id @default(cuid())
  userId            String  @unique
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification settings
  deadCodeAlerts    Boolean @default(true)
  weeklyReports     Boolean @default(true)
  securityAlerts    Boolean @default(true)
  prUpdates         Boolean @default(false)
  
  // Analysis settings
  autoCleanup       Boolean @default(false)
  riskThreshold     String  @default("medium") // low, medium, high
  excludePatterns   String? // JSON array of patterns
  scanFrequency     String  @default("daily") // manual, daily, weekly, monthly
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("user_settings")
}

model Repository {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  githubId    Int      @unique
  name        String
  fullName    String
  description String?
  language    String?
  private     Boolean  @default(false)
  stars       Int      @default(0)
  url         String
  
  isActive    Boolean  @default(true)
  lastScanAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  scans       Scan[]
  deadCode    DeadCode[]

  @@map("repositories")
}

model Scan {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  
  status       String     @default("pending") // pending, running, completed, failed
  totalFiles   Int        @default(0)
  deadFiles    Int        @default(0)
  coverage     Float      @default(0)
  savings      String?    // e.g., "2.1MB"
  riskLevel    String     @default("low") // low, medium, high
  
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
  error        String?

  deadCode     DeadCode[]

  @@map("scans")
}

model DeadCode {
  id           String     @id @default(cuid())
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  scanId       String
  scan         Scan       @relation(fields: [scanId], references: [id], onDelete: Cascade)
  
  filePath     String
  fileName     String
  fileSize     String     // e.g., "2.3kb"
  unusedPercent Int       @default(0)
  lastUsed     DateTime?
  riskLevel    String     @default("low") // low, medium, high
  
  // Code analysis details
  functions    String?    // JSON array of unused functions
  variables    String?    // JSON array of unused variables
  imports      String?    // JSON array of unused imports
  
  isResolved   Boolean    @default(false)
  resolvedAt   DateTime?
  createdAt    DateTime   @default(now())

  @@map("dead_code")
}
